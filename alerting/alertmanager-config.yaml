# Alertmanager é…ç½®
# ç”¨äºæ¥æ”¶ Prometheus æŠ¥è­¦å¹¶å‘é€é€šçŸ¥

global:
  # å…¨å±€é…ç½®
  resolve_timeout: 5m

  # SMTP é…ç½®ï¼ˆé‚®ä»¶é€šçŸ¥ï¼‰
  smtp_smarthost: 'smtp.example.com:587'
  smtp_from: 'alertmanager@example.com'
  smtp_auth_username: '${SMTP_USER}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

  # Slack é…ç½®
  slack_api_url: '${SLACK_WEBHOOK_URL}'

# è·¯ç”±é…ç½®
route:
  # é»˜è®¤æ¥æ”¶è€…
  receiver: 'default-receiver'

  # åˆ†ç»„è§„åˆ™
  group_by: ['alertname', 'severity', 'service_name']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h

  # å­è·¯ç”±
  routes:
    # Critical çº§åˆ«æŠ¥è­¦
    - match:
        severity: critical
      receiver: 'critical-receiver'
      group_wait: 10s
      repeat_interval: 1h

    # Warning çº§åˆ«æŠ¥è­¦
    - match:
        severity: warning
      receiver: 'warning-receiver'
      group_wait: 1m
      repeat_interval: 4h

    # AI å›¢é˜Ÿç›¸å…³æŠ¥è­¦
    - match:
        team: ai-platform
      receiver: 'ai-team-receiver'

    # åŸºç¡€è®¾æ–½æŠ¥è­¦
    - match:
        team: infrastructure
      receiver: 'infra-receiver'

# æ¥æ”¶è€…é…ç½®
receivers:
  - name: 'default-receiver'
    slack_configs:
      - channel: '#alerts-default'
        send_resolved: true
        title: '{{ template "slack.default.title" . }}'
        text: '{{ template "slack.default.text" . }}'

  - name: 'critical-receiver'
    slack_configs:
      - channel: '#alerts-critical'
        send_resolved: true
        title: 'ğŸš¨ Critical Alert: {{ .CommonAnnotations.summary }}'
        text: |
          *Alert:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}
          *Severity:* {{ .CommonLabels.severity }}
          *Service:* {{ .CommonLabels.service_name }}
    email_configs:
      - to: 'oncall@example.com'
        send_resolved: true
    # å¯é€‰ï¼šç”µè¯é€šçŸ¥ï¼ˆé€šè¿‡ PagerDutyï¼‰
    # pagerduty_configs:
    #   - service_key: '${PAGERDUTY_KEY}'
    #     severity: critical

  - name: 'warning-receiver'
    slack_configs:
      - channel: '#alerts-warning'
        send_resolved: true
        title: 'âš ï¸ Warning: {{ .CommonAnnotations.summary }}'
        text: |
          *Alert:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}
          *Severity:* {{ .CommonLabels.severity }}

  - name: 'ai-team-receiver'
    slack_configs:
      - channel: '#ai-platform-alerts'
        send_resolved: true
    email_configs:
      - to: 'ai-team@example.com'

  - name: 'infra-receiver'
    slack_configs:
      - channel: '#infrastructure-alerts'
        send_resolved: true
    email_configs:
      - to: 'infra-team@example.com'

# æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # Critical æŠ‘åˆ¶ Warning
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service_name']

  # Collector down æŠ‘åˆ¶å¯¼å‡ºå¤±è´¥
  - source_match:
      alertname: 'OtelCollectorDown'
    target_match:
      alertname: 'OtelExportFailure'
    equal: ['instance']

# æ¨¡æ¿æ–‡ä»¶
templates:
  - '/etc/alertmanager/templates/*.tmpl'
