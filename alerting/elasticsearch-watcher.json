{
  "description": "åŸºäº Elasticsearch çš„ OpenTelemetry æ•°æ®æŠ¥è­¦é…ç½®",
  "watchers": [
    {
      "name": "high_error_rate_watcher",
      "description": "é«˜é”™è¯¯ç‡æŠ¥è­¦ - å½“5åˆ†é’Ÿå†…é”™è¯¯ç‡è¶…è¿‡5%æ—¶è§¦å‘",
      "trigger": {
        "schedule": {
          "interval": "1m"
        }
      },
      "input": {
        "search": {
          "request": {
            "indices": ["otel-traces-*"],
            "body": {
              "size": 0,
              "query": {
                "bool": {
                  "must": [
                    {
                      "range": {
                        "@timestamp": {
                          "gte": "now-5m"
                        }
                      }
                    }
                  ]
                }
              },
              "aggs": {
                "by_status": {
                  "terms": {
                    "field": "status.code"
                  }
                },
                "total_spans": {
                  "value_count": {
                    "field": "traceId"
                  }
                },
                "error_spans": {
                  "filter": {
                    "term": {
                      "status.code": "ERROR"
                    }
                  }
                }
              }
            }
          }
        }
      },
      "condition": {
        "script": {
          "source": "return ctx.payload.aggregations.error_spans.doc_count > 0 && (ctx.payload.aggregations.error_spans.doc_count / ctx.payload.aggregations.total_spans.value) > 0.05"
        }
      },
      "actions": {
        "send_slack": {
          "webhook": {
            "scheme": "https",
            "host": "hooks.slack.com",
            "port": 443,
            "method": "POST",
            "path": "/services/${SLACK_WEBHOOK_PATH}",
            "body": "{{#toJson}}{'text': 'ğŸš¨ é«˜é”™è¯¯ç‡æŠ¥è­¦: è¿‡å»5åˆ†é’Ÿé”™è¯¯ç‡ä¸º {{ctx.payload.aggregations.error_spans.doc_count}}/{{ctx.payload.aggregations.total_spans.value}}'}{{/toJson}}"
          }
        },
        "send_email": {
          "email": {
            "to": "oncall@example.com",
            "subject": "[ALERT] é«˜é”™è¯¯ç‡æŠ¥è­¦",
            "body": {
              "text": "è¿‡å»5åˆ†é’Ÿå†…æ£€æµ‹åˆ°é«˜é”™è¯¯ç‡ã€‚\né”™è¯¯æ•°: {{ctx.payload.aggregations.error_spans.doc_count}}\næ€»è¯·æ±‚æ•°: {{ctx.payload.aggregations.total_spans.value}}"
            }
          }
        }
      }
    },
    {
      "name": "slow_api_response_watcher",
      "description": "APIå“åº”æ—¶é—´è¿‡é•¿æŠ¥è­¦",
      "trigger": {
        "schedule": {
          "interval": "2m"
        }
      },
      "input": {
        "search": {
          "request": {
            "indices": ["otel-traces-*"],
            "body": {
              "size": 0,
              "query": {
                "bool": {
                  "must": [
                    {
                      "range": {
                        "@timestamp": {
                          "gte": "now-5m"
                        }
                      }
                    },
                    {
                      "term": {
                        "kind": "CLIENT"
                      }
                    }
                  ]
                }
              },
              "aggs": {
                "avg_duration": {
                  "avg": {
                    "field": "duration"
                  }
                },
                "p95_duration": {
                  "percentiles": {
                    "field": "duration",
                    "percents": [95]
                  }
                }
              }
            }
          }
        }
      },
      "condition": {
        "script": {
          "source": "return ctx.payload.aggregations.p95_duration.values['95.0'] > 2000000000"
        }
      },
      "actions": {
        "send_slack": {
          "webhook": {
            "scheme": "https",
            "host": "hooks.slack.com",
            "port": 443,
            "method": "POST",
            "path": "/services/${SLACK_WEBHOOK_PATH}",
            "body": "{{#toJson}}{'text': 'âš ï¸ APIå“åº”æ—¶é—´è¿‡é•¿: P95å»¶è¿Ÿè¶…è¿‡2ç§’'}{{/toJson}}"
          }
        }
      }
    },
    {
      "name": "ai_service_failure_watcher",
      "description": "AIæœåŠ¡è°ƒç”¨å¤±è´¥æŠ¥è­¦",
      "trigger": {
        "schedule": {
          "interval": "1m"
        }
      },
      "input": {
        "search": {
          "request": {
            "indices": ["otel-traces-*"],
            "body": {
              "size": 0,
              "query": {
                "bool": {
                  "must": [
                    {
                      "range": {
                        "@timestamp": {
                          "gte": "now-5m"
                        }
                      }
                    },
                    {
                      "wildcard": {
                        "name": "ai.*"
                      }
                    }
                  ]
                }
              },
              "aggs": {
                "total_ai_calls": {
                  "value_count": {
                    "field": "traceId"
                  }
                },
                "failed_ai_calls": {
                  "filter": {
                    "term": {
                      "status.code": "ERROR"
                    }
                  }
                }
              }
            }
          }
        }
      },
      "condition": {
        "script": {
          "source": "return ctx.payload.aggregations.total_ai_calls.value > 0 && (ctx.payload.aggregations.failed_ai_calls.doc_count / ctx.payload.aggregations.total_ai_calls.value) > 0.1"
        }
      },
      "actions": {
        "send_slack": {
          "webhook": {
            "scheme": "https",
            "host": "hooks.slack.com",
            "port": 443,
            "method": "POST",
            "path": "/services/${SLACK_WEBHOOK_PATH}",
            "body": "{{#toJson}}{'text': 'ğŸš¨ AIæœåŠ¡è°ƒç”¨å¤±è´¥ç‡è¿‡é«˜: å¤±è´¥ç‡è¶…è¿‡10%ï¼Œè¯·æ£€æŸ¥Gemini APIçŠ¶æ€'}{{/toJson}}"
          }
        }
      }
    },
    {
      "name": "no_data_watcher",
      "description": "æ— æ•°æ®æŠ¥è­¦ - å½“10åˆ†é’Ÿå†…æ²¡æœ‰æ”¶åˆ°ä»»ä½•traceæ•°æ®æ—¶è§¦å‘",
      "trigger": {
        "schedule": {
          "interval": "5m"
        }
      },
      "input": {
        "search": {
          "request": {
            "indices": ["otel-traces-*"],
            "body": {
              "size": 0,
              "query": {
                "range": {
                  "@timestamp": {
                    "gte": "now-10m"
                  }
                }
              }
            }
          }
        }
      },
      "condition": {
        "compare": {
          "ctx.payload.hits.total.value": {
            "eq": 0
          }
        }
      },
      "actions": {
        "send_slack": {
          "webhook": {
            "scheme": "https",
            "host": "hooks.slack.com",
            "port": 443,
            "method": "POST",
            "path": "/services/${SLACK_WEBHOOK_PATH}",
            "body": "{{#toJson}}{'text': 'âš ï¸ æ— æ•°æ®æŠ¥è­¦: è¿‡å»10åˆ†é’Ÿæœªæ”¶åˆ°ä»»ä½•é¥æµ‹æ•°æ®ï¼Œè¯·æ£€æŸ¥OpenTelemetry CollectorçŠ¶æ€'}{{/toJson}}"
          }
        }
      }
    }
  ]
}
